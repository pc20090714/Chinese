<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中文 中五上學期 溫習平台 (居家旅行中文溫習必備網站)</title>
    <meta name="description" content="DSE 中文範文溫習：出師表、岳陽樓記修辭分析、海量題庫及智能評分">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #334155; }
        .serif-text { font-family: 'Noto Serif TC', serif; letter-spacing: 0.05em; }
        
        /* 自定義滾動條 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
        
        /* 課文樣式 */
        .text-row { border-bottom: 1px solid #e2e8f0; padding: 2rem 0; }
        .text-row:last-child { border-bottom: none; }
        .original-text { font-family: 'Noto Serif TC', serif; font-size: 1.25rem; line-height: 1.8; color: #1e293b; font-weight: 500; }
        .translation-text { color: #64748b; line-height: 1.7; font-size: 1rem; margin-top: 0.75rem; }
        .note-box { background-color: #fff7ed; border-left: 4px solid #f97316; padding: 1rem; margin-top: 1rem; border-radius: 0 0.5rem 0.5rem 0; font-size: 0.95rem; color: #9a3412; }
        .note-tag { display: inline-block; background: #fed7aa; color: #7c2d12; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold; margin-right: 0.5rem; margin-bottom: 0.25rem;}
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- 導航欄 -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3 cursor-pointer" onclick="showSection('home')">
                    <i class="fa-solid fa-graduation-cap text-emerald-600 text-2xl"></i>
                    <span class="font-bold text-xl tracking-wide text-slate-800">中文<span class="text-emerald-600">DSE</span>智能温習</span>
                </div>
                <div class="hidden md:flex space-x-8">
                    <button onclick="showSection('home')" class="text-slate-600 hover:text-emerald-600 font-medium transition">首頁</button>
                    <button onclick="showSection('study')" class="text-slate-600 hover:text-emerald-600 font-medium transition">課文與修辭</button>
                    <button onclick="showSection('exam')" class="text-slate-600 hover:text-emerald-600 font-medium transition">模擬試卷</button>
                    <button onclick="showSection('history')" class="text-slate-600 hover:text-emerald-600 font-medium transition">成績記錄</button>
                </div>
                <button class="md:hidden text-slate-600" onclick="alert('建議使用桌面版以獲得最佳體驗。')">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- 1. 首頁 -->
        <div id="home-section" class="fade-in">
            <div class="text-center py-16 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-3xl mb-10 border border-emerald-100 shadow-sm relative overflow-hidden">
                <i class="fa-solid fa-pen-nib absolute -right-10 -bottom-10 text-9xl text-emerald-100 opacity-50"></i>
                
                <h1 class="text-4xl md:text-5xl font-bold text-slate-800 mb-6 serif-text">智能評分・錯題檢討</h1>
                <p class="text-lg text-slate-600 mb-8 max-w-2xl mx-auto leading-relaxed">
                    匠心之作：中五學生必備的中文溫習網站。<br>
                    保留海量題庫與修辭賞析，全方位鞏固你的中文根基。
                </p>
                <div class="flex justify-center gap-4 relative z-10">
                    <button onclick="showSection('study')" class="bg-white text-emerald-700 border border-emerald-200 hover:bg-emerald-50 px-8 py-3 rounded-full text-lg font-medium shadow-sm transition">
                        溫習修辭
                    </button>
                    <button onclick="showSection('exam')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-full text-lg font-medium shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">
                        開始挑戰
                    </button>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4 text-blue-600">
                        <i class="fa-solid fa-robot text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">智能關鍵字評分</h3>
                    <p class="text-slate-500 text-sm">無需人手核對！系統會自動偵測你的答案是否包含「得分關鍵詞」，並給予分數。</p>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mb-4 text-orange-600">
                        <i class="fa-solid fa-highlighter text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">修辭與賞析</h3>
                    <p class="text-slate-500 text-sm">完整收錄出師表與岳陽樓記全文，附帶修辭賞析筆記。</p>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-4 text-purple-600">
                        <i class="fa-solid fa-rotate-left text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">錯題回顧功能</h3>
                    <p class="text-slate-500 text-sm">在歷史記錄中查看每一份試卷的詳細答題情況，溫故知新。</p>
                </div>
            </div>
        </div>

        <!-- 2. 溫習區 (Study) -->
        <div id="study-section" class="hidden fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold serif-text border-l-4 border-emerald-500 pl-4">課文全解與賞析</h2>
                <div class="flex gap-2">
                    <button onclick="renderTextContent('chu_shi_biao')" class="px-4 py-2 rounded-lg bg-emerald-100 text-emerald-800 hover:bg-emerald-200 font-medium transition text-btn active" id="btn-text-csb">出師表</button>
                    <button onclick="renderTextContent('yue_yang_lou')" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200 font-medium transition text-btn" id="btn-text-yyl">岳陽樓記</button>
                </div>
            </div>

            <!-- 控制列 -->
            <div class="bg-white p-4 rounded-xl border border-slate-200 mb-6 flex flex-wrap justify-between items-center shadow-sm gap-4">
                <div class="text-slate-600 font-medium"><i class="fa-solid fa-eye mr-2"></i>顯示設定：</div>
                <div class="flex gap-4 text-sm flex-wrap">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="show-trans" checked onchange="renderTextContent(currentTextId)" class="mr-2 text-emerald-600 focus:ring-emerald-500 rounded">
                        <span>顯示語譯</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="show-notes" checked onchange="renderTextContent(currentTextId)" class="mr-2 text-orange-600 focus:ring-orange-500 rounded">
                        <span>顯示修辭賞析</span>
                    </label>
                </div>
            </div>
            
            <div id="study-content" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-10 min-h-[500px]">
                <!-- JS 動態插入 -->
            </div>
        </div>

        <!-- 3. 試卷區 (Exam) -->
        <div id="exam-section" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-3xl font-bold serif-text border-l-4 border-purple-500 pl-4">模擬試卷</h2>
                    <p class="text-slate-500 text-sm mt-1 ml-5">包含 MC、短答及長答題 • 智能評分</p>
                </div>
                <button onclick="startFullExam()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg shadow transition">
                    <i class="fa-solid fa-rotate-right mr-2"></i>刷新試卷
                </button>
            </div>

            <div id="quiz-container" class="bg-white rounded-2xl shadow-lg border border-slate-200 p-8 min-h-[400px]">
                <div class="flex flex-col items-center justify-center h-full text-center py-20">
                    <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-6">
                        <i class="fa-solid fa-brain text-4xl text-slate-400"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-700 mb-2">準備好挑戰了嗎？</h3>
                    <p class="text-slate-500 mb-8 max-w-md">
                        本次考試包含：<br>
                        1. 多項選擇題 (10題)<br>
                        2. 短答題 (2題)<br>
                        3. 長答題 (1題)<br>
                        <span class="text-emerald-600 font-bold mt-2 block"><i class="fa-solid fa-check-circle mr-1"></i> 支援智能關鍵字自動評分</span>
                    </p>
                    <button onclick="startFullExam()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-10 py-3 rounded-full text-lg font-bold shadow-lg transition transform hover:scale-105">開始全卷考試</button>
                    <p class="text-xs text-slate-400 mt-4">系統會優先抽選未做過的題目</p>
                </div>
            </div>
        </div>

        <!-- 4. 歷史記錄 -->
        <div id="history-section" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold serif-text border-l-4 border-blue-500 pl-4">歷史記錄</h2>
                <button onclick="clearHistory()" class="text-red-500 hover:text-red-700 text-sm px-4 py-2 border border-red-200 rounded-lg hover:bg-red-50 transition">
                    <i class="fa-solid fa-trash mr-2"></i>重置所有數據
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-slate-600 text-sm uppercase tracking-wider">
                            <tr>
                                <th class="p-4 font-semibold">日期</th>
                                <th class="p-4 font-semibold">總分</th>
                                <th class="p-4 font-semibold">細項</th>
                                <th class="p-4 font-semibold text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody id="history-list" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
                <div id="empty-history-msg" class="hidden p-12 text-center text-slate-400">
                    <i class="fa-solid fa-ghost text-4xl mb-4 opacity-50"></i>
                    <p>暫無記錄，快去挑戰試卷吧！</p>
                </div>
            </div>
        </div>
    </main>

    <!-- 歷史詳情 Modal (新增) -->
    <div id="history-modal" class="fixed inset-0 z-[100] hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeHistoryModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all scale-100">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                    <h3 class="text-xl font-bold text-slate-800"><i class="fa-solid fa-clipboard-check mr-2 text-blue-500"></i>試卷檢討</h3>
                    <button onclick="closeHistoryModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>
                
                <div id="history-modal-content" class="flex-grow overflow-y-auto p-6 bg-slate-50/50">
                    <!-- 內容由 JS 動態填充 -->
                </div>

                <div class="p-4 border-t border-slate-100 text-right bg-white rounded-b-2xl">
                    <button onclick="closeHistoryModal()" class="bg-slate-800 text-white px-6 py-2 rounded-lg hover:bg-slate-900 transition">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript 邏輯 -->
    <script>
        // --- 1. 課文全文數據 ---
        const TEXTS = {
            chu_shi_biao: {
                title: "諸葛亮《出師表》",
                content: [
                    {
                        original: "先帝創業未半，而中道崩殂；今天下三分，益州疲弊，此誠危急存亡之秋也。",
                        trans: "先帝開創統一大業還沒有完成一半，就中途去世了。現在天下分裂成三個國家，蜀漢人力物力缺乏，這實在是國家處於危急存亡的時刻啊。",
                        notes: ["【借代】「秋」借代為「時刻」或「關鍵時期」。", "【對比】以「創業未半」與「中道崩殂」對比，凸顯形勢危急。"]
                    },
                    {
                        original: "然侍衛之臣，不懈於內；忠志之士，忘身於外者，蓋追先帝之殊遇，欲報之於陛下也。",
                        trans: "然而，侍奉君主的官員在朝廷內毫不懈怠，忠誠的將士在邊疆外捨生忘死，這大概是因為他們追念先帝對他們的特殊禮遇，想要報答在陛下您的身上啊。",
                        notes: ["【對偶】「侍衛之臣，不懈於內」對「忠志之士，忘身於外」。", "【互文】內外臣子皆忠心，雖分述但意通。"]
                    },
                    {
                        original: "誠宜開張聖聽，以光先帝遺德，恢弘志士之氣；不宜妄自菲薄，引喻失義，以塞忠諫之路也。",
                        trans: "陛下實在應該廣泛地聽取別人的意見，來發揚光大先帝遺留下來的美德，振奮擴大志士們的勇氣；不應該隨便看輕自己，引用不恰當的例證，以致堵塞了忠臣進諫的道路。",
                        notes: ["【對比】以「誠宜...」與「不宜...」作強烈對比，勸諫後主。", "【借代】「聖聽」借代為「帝王的聽聞/意見」。"]
                    },
                    {
                        original: "宮中府中，俱為一體，陟罰臧否，不宜異同。若有作奸犯科，及為忠善者，宜付有司，論其刑賞，以昭陛下平明之理；不宜偏私，使內外異法也。",
                        trans: "皇宮裡的近臣和丞相府的官吏，原本都是一個整體，晉升、獎勵、懲罰、批評的標準，不應該有所不同。如果有做壞事觸犯法紀的，或者是盡忠行善的，都應該交給主管的官員，判定他們應得的刑罰或獎賞，來顯示陛下公正嚴明的治理；不應該偏袒私心，使得宮內和宮外的法制不同。",
                        notes: ["【借代】「宮中」代指皇宮/內廷，「府中」代指丞相府。", "【對偶】「陟罰臧否」中包含句中對（陟對罰，臧對否）。"]
                    },
                    {
                        original: "親賢臣，遠小人，此先漢所以興隆也；親小人，遠賢臣，此後漢所以傾頹也。",
                        trans: "親近賢臣，疏遠小人，這是前漢興盛的原因；親近小人，疏遠賢臣，這是後漢衰敗的原因。",
                        notes: ["【排比/對偶】整句結構工整，屬排比亦屬對偶。", "【對比】以「先漢興隆」與「後漢傾頹」作古今對比。"]
                    },
                    {
                        original: "臣本布衣，躬耕於南陽，苟全性命於亂世，不求聞達於諸侯。先帝不以臣卑鄙，猥自枉屈，三顧臣於草廬之中，咨臣以當世之事，由是感激，遂許先帝以驅馳。",
                        trans: "我本來是個平民，在南陽親自耕種，只想在亂世中姑且保全性命，不求在諸侯中揚名顯達。先帝不因為我身分低微見識淺陋，降低身分委屈自己，三次到草廬來探望我，拿當代的大事詢問我，我因此非常感激，就答應為先帝奔走效勞。",
                        notes: ["【借代】「布衣」借代平民。", "【自謙】「卑鄙」、「猥自枉屈」等詞顯示諸葛亮謙虛的態度。"]
                    },
                    {
                        original: "後值傾覆，受任於敗軍之際，奉命於危難之間，爾來二十有一年矣。",
                        trans: "後來遇到兵敗，在兵敗的時候接受重任，在危難的時候奉命出使，從那時到現在已經二十一年了。",
                        notes: ["【對偶】「受任於敗軍之際，奉命於危難之間」。"]
                    },
                    {
                        original: "先帝知臣謹慎，故臨崩寄臣以大事也。受命以來，夙夜憂嘆，恐託付不效，以傷先帝之明；故五月渡瀘，深入不毛。",
                        trans: "先帝知道我做事謹慎，所以臨終時把國家大事託付給我。接受遺命以來，我早晚憂慮嘆息，唯恐託付的事不能成功，有損先帝的知人之明；所以五月渡過瀘水，深入荒涼的地方。",
                        notes: ["【借代】「不毛」借代荒涼之地。", "【誇張】「夙夜憂嘆」形容極度憂慮。"]
                    },
                    {
                        original: "今南方已定，兵甲已足，當獎率三軍，北定中原，庶竭駑鈍，攘除奸凶，興復漢室，還於舊都。此臣所以報先帝而忠陛下之職分也。至於斟酌損益，進盡忠言，則攸之、禕、允之任也。",
                        trans: "現在南方已經平定，武器裝備已經充足，我應當勉勵並率領全軍，北上平定中原，希望能竭盡我低庸的才能，剷除奸邪兇惡的敵人，復興漢室，回到原來的都城。這就是我用來報答先帝並效忠陛下的職責本分。至於衡量得失，提出忠言，就是郭攸之、費禕、董允的責任了。",
                        notes: ["【比喻/自謙】「庶竭駑鈍」以劣馬鈍刀自喻。", "【借代】「奸凶」代指曹魏政權。", "【排比/對偶】「北定中原... 興復漢室... 還於舊都」。"]
                    },
                    {
                        original: "願陛下託臣以討賊興復之效，不效，則治臣之罪，以告先帝之靈。若無興德之言，則責攸之、禕、允等之慢，以彰其咎。陛下亦宜自謀，以咨諏善道，察納雅言，深追先帝遺詔。臣不勝受恩感激。今當遠離，臨表涕零，不知所云。",
                        trans: "希望陛下把討伐奸賊、復興漢室的任務交給我，如果不成功，就治我的罪，來祭告先帝的在天之靈。如果沒有發揚聖德的忠言，就責罰郭攸之、費禕、董允等人的怠慢，來揭示他們的過失。陛下自己也應該多加考慮，詢問治國的好道理，明察和接納正直的言論，深切追念先帝的遺詔。我受恩感激不盡。現在我即將遠離，面對奏表流下眼淚，不知道說了些什麼。",
                        notes: ["【對偶】「治臣之罪」對「責...之慢」。", "【借代】「雅言」指正確合理的言論。", "【情感】「臨表涕零」表現出真摯的忠君愛國之情。"]
                    }
                ]
            },
            yue_yang_lou: {
                title: "范仲淹《岳陽樓記》",
                content: [
                    {
                        original: "慶曆四年春，滕子京謫守巴陵郡。越明年，政通人和，百廢具興。乃重修岳陽樓，增其舊制，刻唐賢今人詩賦於其上。屬予作文以記之。",
                        trans: "慶曆四年的春天，滕子京被貶官擔任巴陵郡太守。到了第二年，政事順利，百姓和樂，各種荒廢了的事業都興辦起來。於是重新修建岳陽樓，擴大了它原本的規模，把唐代名家和今人的詩賦刻在上面。（滕子京）囑咐我寫一篇文章來記述這件事。",
                        notes: ["【對偶】「政通人和，百廢具興」。", "【敘事】本段為記敘背景。"]
                    },
                    {
                        original: "予觀夫巴陵勝狀，在洞庭一湖。銜遠山，吞長江，浩浩湯湯，橫無際涯；朝暉夕陰，氣象萬千。此則岳陽樓之大觀也，前人之述備矣。",
                        trans: "我看那巴陵郡的美景，全在洞庭湖上。它連接遠處的山巒，吞納長江的流水，水勢浩大壯闊，寬橫無邊無際；早晚陰晴變化，景象千變萬化。這就是岳陽樓壯麗的景象，前人的描述已經很詳盡了。",
                        notes: ["【擬人】「銜」遠山，「吞」長江，賦予洞庭湖生命。", "【對偶】「浩浩湯湯，橫無際涯」、「朝暉夕陰，氣象萬千」。"]
                    },
                    {
                        original: "若夫霪雨霏霏，連月不開；陰風怒號，濁浪排空；日星隱曜，山岳潛形；商旅不行，檣傾楫摧；薄暮冥冥，虎嘯猿啼。登斯樓也，則有去國懷鄉，憂讒畏譏，滿目蕭然，感極而悲者矣。",
                        trans: "至於像那連綿大雨細密繁多，幾個月都不放晴；陰冷的風怒吼，渾濁的浪頭衝向天空；太陽星星隱藏了光輝，山岳隱沒了形體；商人和旅客不能通行，船桅傾倒，船槳折斷；傍晚天色昏暗，傳來老虎的吼叫和猿猴的悲啼。這時登上這座樓，就會產生離開國都懷念家鄉，擔心被讒言陷害、畏懼被譏諷的心情，滿眼是蕭條冷落的景象，感慨到極點而感到悲傷。",
                        notes: ["【借代】「檣傾楫摧」：檣(桅)、楫(槳)借代船隻。", "【四字詞/排比】大量運用四字詞描寫陰雨景象，營造壓抑氣氛。"]
                    },
                    {
                        original: "至若春和景明，波瀾不驚，上下天光，一碧萬頃；沙鷗翔集，錦鱗游泳，岸芷汀蘭，郁郁青青。而或長煙一空，皓月千里，浮光躍金，靜影沉璧，漁歌互答，此樂何極！登斯樓也，則有心曠神怡，寵辱偕忘，把酒臨風，其喜洋洋者矣。",
                        trans: "至於像那春氣和暖，陽光普照，水面平靜沒有波浪，天色湖光相連，一片碧綠，廣闊無邊；沙鷗在飛翔或棲息，美麗的魚在水裡游泳，岸上的白芷和小洲上的蘭花，香氣濃郁，顏色青蔥。有時長長的煙霧完全消散，皎潔的月光普照千里，月光照在波動的水面上閃爍著金光，月影映入平靜的水中就像沉下的璧玉，漁夫的歌聲互相應答，這種樂趣哪有窮盡！這時登上這座樓，就會產生心胸開闊、精神愉快，榮耀和屈辱都忘記了，端著酒迎著風，那種喜氣洋洋的感覺。",
                        notes: ["【借代】「錦鱗」借代魚。", "【比喻】「靜影沉璧」：將月影比喻為沉在水底的玉璧。", "【對偶】「浮光躍金，靜影沉璧」。"]
                    },
                    {
                        original: "嗟夫！予嘗求古仁人之心，或異二者之為，何哉？不以物喜，不以己悲。居廟堂之高，則憂其民；處江湖之遠，則憂其君。是進亦憂，退亦憂。然則何時而樂耶？其必曰：「先天下之憂而憂，後天下之樂而樂」歟！噫！微斯人，吾誰與歸？",
                        trans: "唉！我曾經探求古代品德高尚的人的思想感情，或許跟上述兩種表現（因雨而悲、因晴而喜）不同，為什麼呢？（因為他們）不因外在環境好壞而高興，不因個人得失而悲傷。在朝廷做高官，就擔憂他的百姓；被貶謫在偏遠的江湖，就擔憂他的君主。這是做官也擔憂，辭官也擔憂。既然這樣，那麼什麼時候才快樂呢？他們一定會說：「在天下人擔憂之前先擔憂，在天下人快樂之後才快樂」吧！唉！如果沒有這種人，我同誰一道呢？",
                        notes: ["【借代】「廟堂」代指朝廷/高官，「江湖」代指民間/被貶之地。", "【對偶】「居廟堂之高... 處江湖之遠...」。", "【引用/千古名句】「先天下之憂而憂，後天下之樂而樂」。"]
                    }
                ]
            }
        };

        // --- 2. 題庫擴充 ---
        const MC_POOL = [
            // 出師表 - 字詞
            { id: "mc_c_01", q: "「崩殂」意指：", options: ["駕崩", "崩潰", "逃亡", "受傷"], a: "駕崩", topic: "出師表" },
            { id: "mc_c_02", q: "「疲弊」意指：", options: ["困乏", "弊端", "破爛", "失敗"], a: "困乏", topic: "出師表" },
            { id: "mc_c_03", q: "「開張」意指：", options: ["擴大", "營業", "張開", "公開"], a: "擴大", topic: "出師表" },
            { id: "mc_c_04", q: "「引喻失義」之「義」意指：", options: ["適宜", "義氣", "意思", "正義"], a: "適宜", topic: "出師表" },
            { id: "mc_c_05", q: "「陟」意指：", options: ["晉升", "貶謫", "行走", "停止"], a: "晉升", topic: "出師表" },
            { id: "mc_c_06", q: "「臧」意指：", options: ["善/好", "隱藏", "贓物", "收藏"], a: "善/好", topic: "出師表" },
            { id: "mc_c_07", q: "「否」於「陟罰臧否」意指：", options: ["惡/壞", "不", "否定", "停止"], a: "惡/壞", topic: "出師表" },
            { id: "mc_c_08", q: "「簡拔」意指：", options: ["選拔", "簡化", "提拔", "除去"], a: "選拔", topic: "出師表" },
            { id: "mc_c_09", q: "「悉以咨之」之「悉」意指：", options: ["全部", "熟悉", "希望", "詳細"], a: "全部", topic: "出師表" },
            { id: "mc_c_10", q: "「猥」意指：", options: ["辱/降低身份", "猥瑣", "眾多", "勉強"], a: "辱/降低身份", topic: "出師表" },
            { id: "mc_c_11", q: "「庶竭駑鈍」之「庶」意指：", options: ["希望", "平民", "眾多", "幸好"], a: "希望", topic: "出師表" },
            { id: "mc_c_12", q: "「駑」意指：", options: ["劣馬", "努力", "弓箭", "奴僕"], a: "劣馬", topic: "出師表" },
            { id: "mc_c_13", q: "「損」於「斟酌損益」意指：", options: ["減少/革除", "損壞", "批評", "失敗"], a: "減少/革除", topic: "出師表" },
            { id: "mc_c_14", q: "「益」於「斟酌損益」意指：", options: ["增加/興辦", "利益", "益處", "好處"], a: "增加/興辦", topic: "出師表" },
            { id: "mc_c_15", q: "「光」於「以光先帝遺德」作何詞性？", options: ["動詞 (發揚光大)", "名詞 (光線)", "形容詞 (光榮)", "副詞 (只)"], a: "動詞 (發揚光大)", topic: "出師表" },
            { id: "mc_c_16", q: "「恢弘」意指：", options: ["振奮/擴大", "恢復", "宏大", "寬宏"], a: "振奮/擴大", topic: "出師表" },
            { id: "mc_c_17", q: "「痛恨」於文中意指：", options: ["痛心遺憾", "極度憎恨", "疼痛怨恨", "悲痛憤恨"], a: "痛心遺憾", topic: "出師表" },
            { id: "mc_c_18", q: "「感激」於文中意指：", options: ["感動激奮", "感謝", "激動", "感慨"], a: "感動激奮", topic: "出師表" },
            { id: "mc_c_19", q: "「卑鄙」於文中意指：", options: ["身份低微，見識淺陋", "品德惡劣", "行為下流", "無恥"], a: "身份低微，見識淺陋", topic: "出師表" },
            { id: "mc_c_20", q: "「驅馳」意指：", options: ["奔走效勞", "騎馬", "驅趕", "駕駛"], a: "奔走效勞", topic: "出師表" },
            { id: "mc_c_21", q: "「秋」於「危急存亡之秋」意指：", options: ["時刻/關鍵時期", "秋天", "年", "歲月"], a: "時刻/關鍵時期", topic: "出師表" },
            { id: "mc_c_22", q: "「殊遇」意指：", options: ["特殊的禮遇", "特殊的相遇", "不同的遭遇", "幸運"], a: "特殊的禮遇", topic: "出師表" },
            { id: "mc_c_23", q: "「妄自菲薄」意指：", options: ["隨意看輕自己", "狂妄自大", "薄情的行為", "虛妄的言語"], a: "隨意看輕自己", topic: "出師表" },
            { id: "mc_c_24", q: "「雅」於「察納雅言」意指：", options: ["正確/正直", "高雅", "優雅", "很多"], a: "正確/正直", topic: "出師表" },
            { id: "mc_c_25", q: "「布衣」借代什麼？", options: ["平民", "衣服", "裁縫", "窮人"], a: "平民", topic: "出師表" },
            
            // 岳陽樓記 - 字詞
            { id: "mc_y_01", q: "「謫」意指：", options: ["貶官", "升官", "兼任", "暫代"], a: "貶官", topic: "岳陽樓記" },
            { id: "mc_y_02", q: "「具」於「百廢具興」意指：", options: ["全/都", "工具", "具備", "具體"], a: "全/都", topic: "岳陽樓記" },
            { id: "mc_y_03", q: "「湯」於「浩浩湯湯」讀音及意思是：", options: ["shang1，水流大而急", "tang1，熱水", "dang4，動盪", "yang2，廣闊"], a: "shang1，水流大而急", topic: "岳陽樓記" },
            { id: "mc_y_04", q: "「暉」意指：", options: ["日光", "光輝", "晚霞", "陰影"], a: "日光", topic: "岳陽樓記" },
            { id: "mc_y_05", q: "「備」於「前人之述備矣」意指：", options: ["詳盡/完備", "準備", "防備", "裝備"], a: "詳盡/完備", topic: "岳陽樓記" },
            { id: "mc_y_06", q: "「霏霏」形容：", options: ["雨絲細密繁多", "雪花飛舞", "霧氣濃厚", "聲音微弱"], a: "雨絲細密繁多", topic: "岳陽樓記" },
            { id: "mc_y_07", q: "「檣」意指：", options: ["船桅", "船槳", "船帆", "船頭"], a: "船桅", topic: "岳陽樓記" },
            { id: "mc_y_08", q: "「楫」意指：", options: ["船槳", "船桅", "船舵", "船錨"], a: "船槳", topic: "岳陽樓記" },
            { id: "mc_y_09", q: "「薄」於「薄暮冥冥」意指：", options: ["迫近", "輕微", "稀少", "輕薄"], a: "迫近", topic: "岳陽樓記" },
            { id: "mc_y_10", q: "「去」於「去國懷鄉」意指：", options: ["離開", "前往", "除去", "距離"], a: "離開", topic: "岳陽樓記" },
            { id: "mc_y_11", q: "「景」於「春和景明」意指：", options: ["日光", "景色", "景況", "景致"], a: "日光", topic: "岳陽樓記" },
            { id: "mc_y_12", q: "「集」於「沙鷗翔集」意指：", options: ["棲止/停息", "集合", "集市", "群體"], a: "棲止/停息", topic: "岳陽樓記" },
            { id: "mc_y_13", q: "「錦鱗」借代：", options: ["美麗的魚", "波浪", "游泳的人", "龍"], a: "美麗的魚", topic: "岳陽樓記" },
            { id: "mc_y_14", q: "「汀」意指：", options: ["水邊平地", "小島", "河岸", "亭台"], a: "水邊平地", topic: "岳陽樓記" },
            { id: "mc_y_15", q: "「頃」於「一碧萬頃」是：", options: ["面積單位", "時間單位", "重量單位", "長度單位"], a: "面積單位", topic: "岳陽樓記" },
            { id: "mc_y_16", q: "「一」於「長煙一空」意指：", options: ["全/都", "一個", "一旦", "專一"], a: "全/都", topic: "岳陽樓記" },
            { id: "mc_y_17", q: "「浮光躍金」形容：", options: ["月光照在波動水面", "太陽照在靜止水面", "金魚跳躍", "燈光閃爍"], a: "月光照在波動水面", topic: "岳陽樓記" },
            { id: "mc_y_18", q: "「靜影沉璧」形容：", options: ["月影映入平靜水中", "牆壁倒影", "安靜的影子", "沉重的石頭"], a: "月影映入平靜水中", topic: "岳陽樓記" },
            { id: "mc_y_19", q: "「偕」於「寵辱偕忘」意指：", options: ["一起/全", "和諧", "互相", "暫時"], a: "一起/全", topic: "岳陽樓記" },
            { id: "mc_y_20", q: "「把」於「把酒臨風」意指：", options: ["持/拿著", "把握", "靠近", "贈送"], a: "持/拿著", topic: "岳陽樓記" },
            { id: "mc_y_21", q: "「求」於「予嘗求古仁人之心」意指：", options: ["探求", "請求", "要求", "尋找"], a: "探求", topic: "岳陽樓記" },
            { id: "mc_y_22", q: "「微」於「微斯人」意指：", options: ["如果沒有", "微小", "精妙", "卑微"], a: "如果沒有", topic: "岳陽樓記" },
            { id: "mc_y_23", q: "「國」於「去國懷鄉」意指：", options: ["國都", "國家", "故鄉", "邊境"], a: "國都", topic: "岳陽樓記" },
            { id: "mc_y_24", q: "「大觀」意指：", options: ["壯麗景象", "大的觀點", "很多觀眾", "大型建築"], a: "壯麗景象", topic: "岳陽樓記" },
            { id: "mc_y_25", q: "「排空」意指：", options: ["衝向天空", "排除空氣", "排列整齊", "十分空虛"], a: "衝向天空", topic: "岳陽樓記" },

            // 綜合理解
            { id: "mc_mix_01", q: "《出師表》中，諸葛亮認為「先漢」興隆的原因是：", options: ["親賢臣，遠小人", "親小人，遠賢臣", "刑賞分明", "兵精糧足"], a: "親賢臣，遠小人", topic: "出師表" },
            { id: "mc_mix_02", q: "《出師表》中，諸葛亮自述本志是：", options: ["苟全性命於亂世，不求聞達於諸侯", "北定中原，興復漢室", "位極人臣，名留青史", "隱居南陽，終老一生"], a: "苟全性命於亂世，不求聞達於諸侯", topic: "出師表" },
            { id: "mc_mix_03", q: "《岳陽樓記》作者認為古仁人與遷客騷人的最大分別是：", options: ["不以物喜，不以己悲", "文采更好", "官職更高", "更喜歡遊山玩水"], a: "不以物喜，不以己悲", topic: "岳陽樓記" },
            { id: "mc_mix_04", q: "「檣傾楫摧」運用了什麼修辭？", options: ["借代", "比喻", "擬人", "誇張"], a: "借代", topic: "岳陽樓記" },
            { id: "mc_mix_05", q: "「急湍甚箭」運用了什麼修辭？", options: ["比喻", "擬人", "借代", "反問"], a: "比喻", topic: "其他" },
            { id: "mc_mix_06", q: "「銜遠山，吞長江」運用了什麼修辭？", options: ["擬人/對偶", "排比", "借代", "反語"], a: "擬人/對偶", topic: "岳陽樓記" },
            { id: "mc_mix_07", q: "「先天下之憂而憂，後天下之樂而樂」是誰的名言？", options: ["范仲淹", "諸葛亮", "蘇軾", "王安石"], a: "范仲淹", topic: "岳陽樓記" },
            { id: "mc_mix_08", q: "諸葛亮在《出師表》中向後主提出了三條建議，不包括：", options: ["擴張領土", "廣開言路", "賞罰分明", "親賢遠小"], a: "擴張領土", topic: "出師表" },
            { id: "mc_mix_09", q: "《岳陽樓記》中「進亦憂，退亦憂」的「進」是指：", options: ["居廟堂之高 (做官)", "向前進攻", "進步", "進入岳陽樓"], a: "居廟堂之高 (做官)", topic: "岳陽樓記" },
            { id: "mc_mix_10", q: "《出師表》一文的文體是：", options: ["表 (奏章)", "記 (記敘)", "詩", "賦"], a: "表 (奏章)", topic: "出師表" }
        ];

        const SHORT_Q_POOL = [
            { id: "sq_01", q: "《出師表》中，諸葛亮提出了哪三項主要的治國建議？", keywords: ["廣開言路", "開張聖聽", "賞罰分明", "陟罰臧否", "親賢遠小", "親賢臣"], topic: "出師表" },
            { id: "sq_02", q: "《岳陽樓記》中，「檣傾楫摧」運用了什麼修辭手法？請略加說明。", keywords: ["借代", "借喻", "檣", "楫", "船"], topic: "岳陽樓記" },
            { id: "sq_03", q: "解釋《出師表》中「庶竭駑鈍」一詞的意思。", keywords: ["竭盡", "低庸", "才能", "劣馬", "自謙"], topic: "出師表" },
            { id: "sq_04", q: "《岳陽樓記》中，作者描寫「春和景明」的景色，是為了襯托遷客騷人怎樣的心情？", keywords: ["喜", "快樂", "心曠神怡", "寵辱偕忘", "以物喜"], topic: "岳陽樓記" },
            { id: "sq_05", q: "試解釋「不以物喜，不以己悲」的意思。", keywords: ["環境", "外在", "個人", "得失", "心情", "影響"], topic: "岳陽樓記" },
            { id: "sq_06", q: "諸葛亮在《出師表》中自稱「布衣」，這詞是什麼意思？運用了什麼修辭？", keywords: ["平民", "借代"], topic: "出師表" },
            { id: "sq_07", q: "《岳陽樓記》中「錦鱗游泳」的「錦鱗」是指什麼？這是什麼修辭？", keywords: ["魚", "美麗的魚", "借代"], topic: "岳陽樓記" },
            { id: "sq_08", q: "諸葛亮為何在《出師表》中多次提及「先帝」？(寫出一點即可)", keywords: ["激勵", "感激", "權威", "動之以情", "效法"], topic: "出師表" },
            { id: "sq_09", q: "「銜遠山，吞長江」中的「銜」和「吞」字運用了什麼修辭手法？", keywords: ["擬人"], topic: "岳陽樓記" },
            { id: "sq_10", q: "《出師表》中「猥自枉屈」表達了諸葛亮怎樣的感情？", keywords: ["感激", "謙虛", "自謙", "知遇之恩"], topic: "出師表" },
            { id: "sq_11", q: "《岳陽樓記》中，作者以什麼天氣來引發「感極而悲」的情緒？", keywords: ["雨", "霪雨", "陰", "壞天氣"], topic: "岳陽樓記" },
            { id: "sq_12", q: "諸葛亮認為「先漢」興隆的原因是什麼？", keywords: ["親賢", "遠小", "親近賢臣"], topic: "出師表" },
            { id: "sq_13", q: "「浮光躍金，靜影沉璧」描寫的是什麼時間的景色？", keywords: ["晚上", "月夜", "皓月"], topic: "岳陽樓記" },
            { id: "sq_14", q: "《出師表》中，諸葛亮出師的最終目標是什麼？", keywords: ["興復漢室", "還於舊都", "北定中原"], topic: "出師表" }
        ];

        const LONG_Q_POOL = [
            { id: "lq_01", q: "試綜合《岳陽樓記》全文，分析「古仁人」與「遷客騷人」在面對外在環境變化時，心態上有何不同？", keywords: ["遷客騷人", "受環境影響", "以物喜", "以己悲", "古仁人", "不受影響", "擔憂", "先天下之憂"], topic: "岳陽樓記" },
            { id: "lq_02", q: "在《出師表》中，諸葛亮反覆提及「先帝」，這在寫作手法上有何作用？試加以說明。", keywords: ["說服力", "動之以情", "權威", "不忍拒絕", "忠誠", "報答"], topic: "出師表" },
            { id: "lq_03", q: "試比較《出師表》與《岳陽樓記》兩文作者在文中流露的憂國憂民情懷。", keywords: ["諸葛亮", "死而後已", "報恩", "興復漢室", "范仲淹", "先天下之憂", "居廟堂", "處江湖"], topic: "綜合" },
            { id: "lq_04", q: "《岳陽樓記》中，范仲淹借描寫洞庭湖的景色來抒發己見，這種寫作手法叫什麼？試結合內容略加說明。", keywords: ["借景抒情", "寓情於景", "陰雨", "悲", "晴朗", "喜", "對比"], topic: "岳陽樓記" },
            { id: "lq_05", q: "諸葛亮在《出師表》中對後主劉禪的語氣是如何的？試舉例說明。", keywords: ["長輩", "臣子", "懇切", "直諫", "不宜", "誠宜", "父輩"], topic: "出師表" },
            { id: "lq_06", q: "分析「先天下之憂而憂，後天下之樂而樂」這句話的含義及其在全文中的作用。", keywords: ["點明主旨", "政治抱負", "擔憂", "享樂", "吃苦在前", "昇華"], topic: "岳陽樓記" },
            { id: "lq_07", q: "試分析《出師表》中諸葛亮「親賢遠小」建議的現實意義。", keywords: ["人才", "小人", "管治", "興衰", "歷史教訓"], topic: "出師表" }
        ];

        // --- 3. 系統狀態與邏輯 ---
        let currentExam = { mc: [], short: [], long: [], answers: { mc: {}, short: {}, long: {} }, scores: { mc: 0, short: {}, long: {} } };
        let historyData = JSON.parse(localStorage.getItem('dse_history_smart_v1') || '[]');
        let currentTextId = 'chu_shi_biao';

        let usedIDs = {
            mc: JSON.parse(localStorage.getItem('dse_used_mc') || '[]'),
            short: JSON.parse(localStorage.getItem('dse_used_short') || '[]'),
            long: JSON.parse(localStorage.getItem('dse_used_long') || '[]')
        };

        // --- 4. 顯示控制 ---
        function init() {
            updateHistoryDisplay();
            renderTextContent('chu_shi_biao');
            const lastSection = localStorage.getItem('dse_smart_last_section') || 'home';
            showSection(lastSection);
        }

        function showSection(sectionId) {
            ['home', 'study', 'exam', 'history'].forEach(id => document.getElementById(`${id}-section`).classList.add('hidden'));
            document.getElementById(`${sectionId}-section`).classList.remove('hidden');
            localStorage.setItem('dse_smart_last_section', sectionId);
        }

        // --- 5. 課文渲染邏輯 ---
        function renderTextContent(textId) {
            currentTextId = textId;
            const data = TEXTS[textId];
            const showTrans = document.getElementById('show-trans').checked;
            const showNotes = document.getElementById('show-notes').checked;
            
            document.querySelectorAll('.text-btn').forEach(btn => {
                const isActive = (btn.id === (textId === 'chu_shi_biao' ? 'btn-text-csb' : 'btn-text-yyl'));
                btn.className = `px-4 py-2 rounded-lg font-medium transition text-btn ${isActive ? 'bg-emerald-100 text-emerald-800' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`;
            });

            const container = document.getElementById('study-content');
            let html = `<h3 class="text-2xl font-bold text-slate-800 mb-6 text-center border-b pb-4">${data.title}</h3>`;
            
            data.content.forEach((para) => {
                html += `
                    <div class="text-row group hover:bg-slate-50 transition px-2 rounded">
                        <div class="original-text text-justify">${para.original}</div>
                        ${showTrans ? `<div class="translation-text text-justify border-l-4 border-emerald-200 pl-3">${para.trans}</div>` : ''}
                        ${showNotes && para.notes ? `
                            <div class="note-box">
                                <i class="fa-solid fa-lightbulb mr-1"></i> <strong>賞析重點：</strong><br>
                                <div class="mt-1">${para.notes.map(n => `<div class="mb-1">${n.replace(/【(.*?)】/g, '<span class="note-tag">$1</span>')}</div>`).join('')}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // --- 6. 考試邏輯 ---

        function getQuestions(pool, count, type) {
            let available = pool.filter(q => !usedIDs[type].includes(q.id));
            
            if (available.length < count) {
                usedIDs[type] = [];
                localStorage.setItem(`dse_used_${type}`, '[]');
                available = pool;
            }

            const shuffled = available.sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, count);

            const newUsed = selected.map(q => q.id);
            usedIDs[type] = [...usedIDs[type], ...newUsed];
            localStorage.setItem(`dse_used_${type}`, JSON.stringify(usedIDs[type]));

            return selected;
        }

        function startFullExam() {
            currentExam = { mc: [], short: [], long: [], answers: { mc: {}, short: {}, long: {} }, scores: { mc: 0, short: {}, long: {} } };
            
            currentExam.mc = getQuestions(MC_POOL, 10, 'mc');
            currentExam.short = getQuestions(SHORT_Q_POOL, 2, 'short');
            currentExam.long = getQuestions(LONG_Q_POOL, 1, 'long');

            renderExamPaper();
        }

        function renderExamPaper() {
            const container = document.getElementById('quiz-container');
            let html = `<div class="space-y-10 text-left fade-in">`;

            // Part 1
            html += `<div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-4 flex justify-between items-center"><h3 class="font-bold text-blue-800">第一部分：多項選擇題 (10分)</h3><span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded">電腦批改</span></div>`;
            currentExam.mc.forEach((q, idx) => {
                const options = [...q.options].sort(() => 0.5 - Math.random());
                html += `
                    <div class="mb-8">
                        <p class="font-bold text-slate-800 mb-3"><span class="inline-block w-6 h-6 bg-blue-600 text-white text-center rounded text-sm leading-6 mr-2">${idx+1}</span>${q.q}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 ml-8">
                            ${options.map(opt => `
                                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-slate-50 transition ${currentExam.answers.mc[idx] === opt ? 'border-blue-500 bg-blue-50' : 'border-slate-200'}">
                                    <input type="radio" name="mc_${idx}" value="${opt}" class="mr-3" onchange="recordAnswer('mc', ${idx}, '${opt}')" ${currentExam.answers.mc[idx] === opt ? 'checked' : ''}>
                                    <span>${opt}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            // Part 2
            html += `<div class="bg-amber-50 p-4 rounded-lg border-l-4 border-amber-500 mb-4 mt-8 flex justify-between items-center"><h3 class="font-bold text-amber-800">第二部分：短答題 (每題3分)</h3><span class="text-xs bg-amber-200 text-amber-800 px-2 py-1 rounded">智能關鍵字評分</span></div>`;
            currentExam.short.forEach((q, idx) => {
                html += `
                    <div class="mb-8 p-4 border border-slate-200 rounded-xl bg-white">
                        <p class="font-bold text-slate-800 mb-3"><span class="inline-block w-6 h-6 bg-amber-600 text-white text-center rounded text-sm leading-6 mr-2">S${idx+1}</span>${q.q}</p>
                        <textarea placeholder="請輸入答案 (系統將分析關鍵字)..." class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500 outline-none" rows="3" oninput="recordAnswer('short', ${idx}, this.value)">${currentExam.answers.short[idx] || ''}</textarea>
                    </div>
                `;
            });

            // Part 3
            html += `<div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500 mb-4 mt-8 flex justify-between items-center"><h3 class="font-bold text-purple-800">第三部分：長答題 (每題6分)</h3><span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded">智能關鍵字評分</span></div>`;
            currentExam.long.forEach((q, idx) => {
                html += `
                    <div class="mb-8 p-4 border border-slate-200 rounded-xl bg-white">
                        <p class="font-bold text-slate-800 mb-3"><span class="inline-block w-6 h-6 bg-purple-600 text-white text-center rounded text-sm leading-6 mr-2">L${idx+1}</span>${q.q}</p>
                        <textarea placeholder="請詳盡作答..." class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none" rows="5" oninput="recordAnswer('long', ${idx}, this.value)">${currentExam.answers.long[idx] || ''}</textarea>
                    </div>
                `;
            });

            html += `
                <div class="text-center pt-8 border-t border-slate-100 mt-8">
                    <button onclick="submitToAI()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-12 py-3 rounded-full text-lg font-bold shadow-lg hover:shadow-emerald-200/50 transition">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>提交並智能評分
                    </button>
                </div>
            </div>`;

            container.innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function recordAnswer(type, idx, val) {
            currentExam.answers[type][idx] = val;
        }

        // --- 7. 智能評分系統 ---

        function calculateKeywordScore(userText, keywords, maxScore) {
            if (!userText) return { score: 0, matches: [], missing: keywords };
            
            let matchCount = 0;
            let matches = [];
            let missing = [];

            keywords.forEach(kw => {
                if (userText.includes(kw)) {
                    matchCount++;
                    matches.push(kw);
                } else {
                    missing.push(kw);
                }
            });

            let ratio = matchCount / keywords.length;
            let score = Math.min(maxScore, Math.ceil(ratio * maxScore));
            
            if (score === 0 && userText.length > 10) score = 1;

            return { score, matches, missing };
        }

        function submitToAI() {
            const container = document.getElementById('quiz-container');
            let totalScore = 0;
            
            let mcScore = 0;
            currentExam.mc.forEach((q, i) => {
                if (currentExam.answers.mc[i] === q.a) mcScore++;
            });
            currentExam.scores.mc = mcScore;
            totalScore += mcScore;

            let html = `
                <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-8 rounded-2xl shadow-lg text-white mb-8 text-center fade-in">
                    <h3 class="text-2xl font-bold mb-2">智能評分完成！</h3>
                    <p class="opacity-90">系統已根據關鍵字命中率自動給分。</p>
                </div>
                
                <div class="bg-white p-6 rounded-xl border border-slate-200 mb-8 shadow-sm">
                    <h4 class="font-bold text-slate-700 border-b pb-2 mb-4">第一部分：選擇題</h4>
                    <p class="text-3xl font-bold text-blue-600">${mcScore} <span class="text-base text-slate-400 font-normal">/ 10 分</span></p>
                </div>
            `;

            let shortTotal = 0;
            let shortDetails = [];
            html += `<div class="bg-white p-6 rounded-xl border border-slate-200 mb-8 shadow-sm"><h4 class="font-bold text-slate-700 border-b pb-4 mb-4">第二部分：短答題 (智能分析)</h4><div class="space-y-6">`;
            
            currentExam.short.forEach((q, idx) => {
                const ans = currentExam.answers.short[idx] || "";
                const result = calculateKeywordScore(ans, q.keywords, 3);
                currentExam.scores.short[idx] = result.score;
                shortTotal += result.score;
                
                // Store detail for history
                shortDetails.push({
                    q: q.q,
                    user: ans,
                    keywords: q.keywords,
                    score: result.score,
                    analysis: result
                });

                html += `
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-slate-700">S${idx+1}. ${q.q}</span>
                            <span class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full font-bold text-sm">${result.score}/3 分</span>
                        </div>
                        <p class="text-sm text-slate-600 mb-2"><strong>你的答案：</strong>${ans || '<span class="text-slate-400">未作答</span>'}</p>
                        <div class="text-xs bg-white border border-slate-200 p-2 rounded">
                            <span class="text-green-600"><i class="fa-solid fa-check"></i> 命中關鍵字：${result.matches.length > 0 ? result.matches.join(', ') : '無'}</span><br>
                            <span class="text-red-400"><i class="fa-solid fa-xmark"></i> 建議補充：${result.missing.join(', ')}</span>
                        </div>
                    </div>
                `;
            });
            html += `</div></div>`;
            totalScore += shortTotal;

            let longTotal = 0;
            let longDetails = [];
            html += `<div class="bg-white p-6 rounded-xl border border-slate-200 mb-8 shadow-sm"><h4 class="font-bold text-slate-700 border-b pb-4 mb-4">第三部分：長答題 (智能分析)</h4><div class="space-y-6">`;
            
            currentExam.long.forEach((q, idx) => {
                const ans = currentExam.answers.long[idx] || "";
                const result = calculateKeywordScore(ans, q.keywords, 6);
                currentExam.scores.long[idx] = result.score;
                longTotal += result.score;
                
                // Store detail for history
                longDetails.push({
                    q: q.q,
                    user: ans,
                    keywords: q.keywords,
                    score: result.score,
                    analysis: result
                });

                html += `
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-slate-700">L${idx+1}. ${q.q}</span>
                            <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full font-bold text-sm">${result.score}/6 分</span>
                        </div>
                        <p class="text-sm text-slate-600 mb-2"><strong>你的答案：</strong>${ans || '<span class="text-slate-400">未作答</span>'}</p>
                        <div class="text-xs bg-white border border-slate-200 p-2 rounded">
                            <span class="text-green-600"><i class="fa-solid fa-check"></i> 命中關鍵字：${result.matches.length > 0 ? result.matches.join(', ') : '無'}</span><br>
                            <span class="text-red-400"><i class="fa-solid fa-xmark"></i> 建議補充：${result.missing.join(', ')}</span>
                        </div>
                    </div>
                `;
            });
            html += `</div></div>`;
            totalScore += longTotal;

            const maxScore = 10 + (currentExam.short.length * 3) + (currentExam.long.length * 6);
            
            // Construct Detailed Record
            const record = {
                id: Date.now(),
                date: new Date().toLocaleString('zh-HK'),
                score: totalScore,
                maxScore: maxScore,
                breakdown: { mc: mcScore, short: shortTotal, long: longTotal },
                details: {
                    mc: currentExam.mc.map((q, i) => ({
                        q: q.q,
                        user: currentExam.answers.mc[i],
                        correct: q.a,
                        isCorrect: currentExam.answers.mc[i] === q.a,
                        options: q.options
                    })),
                    short: shortDetails,
                    long: longDetails
                }
            };

            historyData.unshift(record);
            localStorage.setItem('dse_history_smart_v1', JSON.stringify(historyData));
            updateHistoryDisplay();

            html += `
                <div class="text-center pt-4">
                    <p class="text-xl font-bold text-slate-800 mb-6">總分：${totalScore} / ${maxScore}</p>
                    <button onclick="startFullExam()" class="bg-slate-800 hover:bg-slate-900 text-white px-8 py-3 rounded-full font-medium shadow-lg transition">再來一份</button>
                </div>
            `;

            container.innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- 8. 歷史記錄 & 檢討功能 ---
        function updateHistoryDisplay() {
            const list = document.getElementById('history-list');
            const emptyMsg = document.getElementById('empty-history-msg');
            
            if (historyData.length === 0) {
                list.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                return;
            }

            emptyMsg.classList.add('hidden');
            list.innerHTML = historyData.map((h) => `
                <tr class="hover:bg-slate-50 transition border-b border-slate-100">
                    <td class="p-4 text-slate-600 text-sm">${h.date.split(' ')[0]}<br><span class="text-xs text-slate-400">${h.date.split(' ')[1]||''}</span></td>
                    <td class="p-4 font-bold text-slate-800">${h.score} / ${h.maxScore}</td>
                    <td class="p-4 text-xs text-slate-500">MC:${h.breakdown.mc} 短:${h.breakdown.short} 長:${h.breakdown.long}</td>
                    <td class="p-4 text-right">
                        ${h.details ? 
                            `<button onclick="viewHistoryDetail(${h.id})" class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1 rounded text-xs font-medium transition">查看詳情</button>` : 
                            `<span class="text-slate-300 text-xs">無詳情</span>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        function viewHistoryDetail(id) {
            const record = historyData.find(h => h.id === id);
            if (!record || !record.details) return;

            const content = document.getElementById('history-modal-content');
            let html = `
                <div class="mb-6 flex items-center justify-between">
                    <div>
                        <span class="text-sm text-slate-500">考試日期</span>
                        <p class="font-bold text-slate-800">${record.date}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-sm text-slate-500">總分</span>
                        <p class="font-bold text-2xl text-emerald-600">${record.score} / ${record.maxScore}</p>
                    </div>
                </div>
            `;

            // MC Review
            html += `<h4 class="font-bold text-slate-700 border-l-4 border-blue-500 pl-3 mb-4">第一部分：選擇題 (${record.breakdown.mc}/10)</h4>`;
            html += `<div class="grid grid-cols-1 gap-4 mb-8">`;
            record.details.mc.forEach((d, i) => {
                const color = d.isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50';
                html += `
                    <div class="p-3 border rounded-lg ${color}">
                        <p class="text-sm font-bold text-slate-700 mb-1">${i+1}. ${d.q}</p>
                        <div class="flex justify-between text-xs">
                            <span class="${d.isCorrect ? 'text-green-700' : 'text-red-600'}">你的選擇：${d.user || '未作答'}</span>
                            ${!d.isCorrect ? `<span class="text-green-700 font-bold">正確答案：${d.correct}</span>` : ''}
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            // Short Review
            html += `<h4 class="font-bold text-slate-700 border-l-4 border-amber-500 pl-3 mb-4">第二部分：短答題 (${record.breakdown.short})</h4>`;
            html += `<div class="space-y-4 mb-8">`;
            record.details.short.forEach((d, i) => {
                html += `
                    <div class="p-4 border border-slate-200 rounded-lg bg-white">
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-bold text-slate-700">S${i+1}. ${d.q}</span>
                            <span class="text-xs bg-amber-100 text-amber-800 px-2 py-1 rounded">${d.score}/3 分</span>
                        </div>
                        <p class="text-xs text-slate-500 mb-1">你的回答：</p>
                        <p class="text-sm text-slate-800 mb-3 bg-slate-50 p-2 rounded">${d.user || '未作答'}</p>
                        <div class="text-xs">
                            <p class="text-green-600 mb-1"><i class="fa-solid fa-check"></i> 命中：${d.analysis.matches.join(', ') || '無'}</p>
                            <p class="text-red-400"><i class="fa-solid fa-xmark"></i> 缺漏：${d.analysis.missing.join(', ')}</p>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

             // Long Review
            html += `<h4 class="font-bold text-slate-700 border-l-4 border-purple-500 pl-3 mb-4">第三部分：長答題 (${record.breakdown.long})</h4>`;
            html += `<div class="space-y-4">`;
            record.details.long.forEach((d, i) => {
                html += `
                    <div class="p-4 border border-slate-200 rounded-lg bg-white">
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-bold text-slate-700">L${i+1}. ${d.q}</span>
                            <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">${d.score}/6 分</span>
                        </div>
                        <p class="text-xs text-slate-500 mb-1">你的回答：</p>
                        <p class="text-sm text-slate-800 mb-3 bg-slate-50 p-2 rounded">${d.user || '未作答'}</p>
                        <div class="text-xs">
                            <p class="text-green-600 mb-1"><i class="fa-solid fa-check"></i> 命中：${d.analysis.matches.join(', ') || '無'}</p>
                            <p class="text-red-400"><i class="fa-solid fa-xmark"></i> 缺漏：${d.analysis.missing.join(', ')}</p>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            content.innerHTML = html;
            
            // Show Modal
            document.getElementById('history-modal').classList.remove('hidden');
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.add('hidden');
        }

        function clearHistory() {
            localStorage.removeItem('dse_history_smart_v1');
            localStorage.removeItem('dse_used_mc');
            localStorage.removeItem('dse_used_short');
            localStorage.removeItem('dse_used_long');
            historyData = [];
            usedIDs = { mc: [], short: [], long: [] };
            updateHistoryDisplay();
        }

        init();
    </script>
</body>
</html>